# Bag Replay Tool - 사용 가이드

## 설치

### 전제 조건
- ROS2 설치됨
- Python 3.8 이상
- PyQt5

### 설치 과정

```bash
# 워크스페이스로 이동
cd ~/ros2_ws

# 빌드
colcon build --packages-select bag_replay_tool_ros2

# 환경 설정
source install/setup.bash
```

## 실행 방법

### 1. Launch 파일을 통한 실행
```bash
ros2 launch bag_replay_tool_ros2 bag_replay_tool.launch.py
```

### 2. 직접 실행
```bash
ros2 run bag_replay_tool_ros2 bag_replay_tool_node
```

## GUI 사용법

### 메인 화면 구성

```
┌─ Bag Replay Tool ──────────────────────────────┐
│ ┌─ 파일 선택 ───────────────────────────────┐ │
│ │ [Browse...]  [파일 경로]                 │ │
│ └───────────────────────────────────────────┘ │
│                                               │
│ ┌─ 토픽 선택 ───────────────────────────────┐ │
│ │ ☑ /camera/image_raw (sensor_msgs/...)   │ │
│ │ ☑ /imu (sensor_msgs/Imu)                │ │
│ │ ☑ /gps/fix (sensor_msgs/NavSatFix)      │ │
│ └───────────────────────────────────────────┘ │
│                                               │
│ ┌─ 재생 제어 ───────────────────────────────┐ │
│ │ [▶ 재생] [⏸ 일시중지] [⏹ 중지]          │ │
│ │ Status: Playing (녹색)                   │ │
│ └───────────────────────────────────────────┘ │
│                                               │
│ ┌─ 옵션 ────────────────────────────────────┐ │
│ │ ☑ 루프 재생                              │ │
│ │ 재생 속도: [1.0x] (0.1 ~ 10.0)         │ │
│ │ ☐ 시간(Clock) 발행                      │ │
│ └───────────────────────────────────────────┘ │
│                                               │
│ ┌─ Bag 정보 ────────────────────────────────┐ │
│ │ File: bag_file_name                     │ │
│ │ Topics: 5, Duration: 120.5s             │ │
│ │ [상세 정보 표시]                         │ │
│ └───────────────────────────────────────────┘ │
└───────────────────────────────────────────────┘
```

### 단계별 사용

#### 1단계: Bag 파일 선택

**방법 1: Browse 버튼**
- `Browse...` 버튼 클릭
- 파일 브라우저에서 ROS2 bag 디렉토리 선택
  - 예: `/home/user/bags/my_recording_2026-01-28`
- `metadata.yaml` 파일이 있는 디렉토리여야 함

**방법 2: File 메뉴**
- File → Open Bag File... (Ctrl+O)
- 디렉토리 선택

**방법 3: 최근 파일 메뉴**
- File → Recent Files
- 목록에서 선택

#### 2단계: 토픽 선택

- 토픽 목록에서 체크박스로 원하는 토픽 선택
- 각 토픽 정보:
  - 토픽 이름 (예: `/camera/image_raw`)
  - 메시지 타입 (예: `sensor_msgs/Image`)
  - 메시지 개수 (예: `1245 msgs`)
- 모든 토픽을 발행하려면 모두 체크
- 특정 토픽만 발행하려면 해당 토픽만 체크

#### 3단계: 재생 옵션 설정

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| **루프 재생** | 녹음 끝에 도달하면 처음부터 다시 재생 | ON |
| **재생 속도** | 배속 조절 (0.1배 ~ 10배) | 1.0배 |
| **시간(Clock) 발행** | `/clock` 토픽을 통해 시뮬레이션 시간 발행 | OFF |

#### 4단계: 재생 제어

**Play (▶)**
- 선택된 토픽 재생 시작
- 일시중지된 상태에서 누르면 재개

**Pause (⏸)**
- 현재 재생 일시중지
- 다시 Play 누르면 계속 재생

**Stop (⏹)**
- 재생 완전 중지
- 처음부터 다시 재생하려면 Play 누르기

#### 5단계: Bag 정보 확인

- 오른쪽 하단의 "Bag 정보" 영역에서 확인
- 상세 정보 내용:
  - 파일 경로
  - 시간 범위 (start, end, duration)
  - 토픽 목록
  - 메시지 수

## 메뉴 구성

### File 메뉴
- **Open Bag File... (Ctrl+O)**: 새 bag 파일 열기
- **Recent Files**: 최근 사용한 파일 (최대 10개)
- **Clear Recent Files**: 최근 파일 목록 삭제
- **Exit**: 프로그램 종료

## 최근 파일 관리

### 자동 저장
- Bag 파일 선택 시 자동으로 최근 파일 목록에 추가
- 최대 10개 파일 유지
- 같은 파일 선택 시 목록 맨 위로 이동

### 저장 위치
```
~/.ros2/bag_replay_tool_recent.json
```

### 저장 형식
```json
[
  "/home/user/bags/recording_1",
  "/home/user/bags/recording_2",
  "/home/user/bags/recording_3"
]
```

### 자동 정리
- 삭제된 파일은 자동으로 목록에서 제거
- 프로그램 시작 시 검증

## 상태 표시

| 상태 | 색상 | 의미 |
|------|------|------|
| **Playing** | 🟢 녹색 | 재생 중 |
| **Paused** | 🟠 주황색 | 일시중지됨 |
| **Stopped** | 🔴 빨강색 | 중지됨 |

## 로깅 출력

프로그램은 ROS2 logger를 사용하여 상세한 로그 메시지 출력:

```
✅ Success: 성공
❌ Error: 오류
⚠️  Warning: 경고
📁 File operation: 파일 작업
🎬 Playback: 재생 관련
📋 Topics: 토픽 관련
💾 Save: 저장
🧹 Cleanup: 정리
```

### 로그 확인 방법
```bash
# 전체 로그 확인
ros2 topic echo /rosout

# 필터링된 로그 확인
ros2 run rqt_console rqt_console
```

## 일반적인 사용 시나리오

### 시나리오 1: 단일 카메라 토픽 재생
1. Bag 파일 선택
2. `/camera/image_raw` 만 체크
3. 다른 토픽 체크 해제
4. Play 클릭

### 시나리오 2: 여러 센서 데이터 반복 재생
1. Bag 파일 선택
2. 모든 센서 토픽 체크
3. "루프 재생" ON
4. "시간(Clock) 발행" ON (필요시)
5. Play 클릭

### 시나리오 3: 슬로우 모션 분석
1. Bag 파일 선택
2. 재생 속도를 0.2x로 설정
3. Play 클릭

### 시나리오 4: 빠른 미리보기
1. Bag 파일 선택
2. 재생 속도를 5.0x로 설정
3. Play 클릭

## 문제 해결

### Q: "Invalid Bag" 오류가 나타남
**A**: 선택한 디렉토리가 유효한 ROS2 bag이 아닙니다.
- `metadata.yaml` 파일 확인
- `.db3` 파일 존재 확인

### Q: 재생이 시작되지 않음
**A**: 다음을 확인하세요:
- 토픽이 최소 1개 이상 선택되어 있는지 확인
- bag 파일 경로가 유효한지 확인
- 로그에서 오류 메시지 확인

### Q: 일시중지 후 재개가 안 됨
**A**: 일부 토픽 타입에서는 일시중지 재개가 작동하지 않을 수 있습니다.
- Stop 후 다시 Play를 시도

### Q: 최근 파일이 표시되지 않음
**A**: 다음을 확인하세요:
- `~/.ros2/` 디렉토리 생성 확인
- 파일 권한 확인
- 최근 파일이 실제로 존재하는지 확인

## 팁 및 트릭

1. **키보드 단축키**
   - Ctrl+O: Open Bag File
   - Spacebar: Play/Pause (구현 시)

2. **재생 속도 조절**
   - 0.1x ~ 0.5x: 상세 분석
   - 1.0x: 정상 속도
   - 2.0x ~ 10.0x: 빠른 미리보기

3. **메모리 관리**
   - 대용량 bag 파일은 특정 토픽만 선택하여 메모리 절약
   - 재생 중 응답성이 떨어지면 배경에서 실행되는 다른 프로세스 확인

4. **시간 동기화**
   - 여러 노드가 clock 메시지에 의존하는 경우 "시간(Clock) 발행" 옵션 활용
